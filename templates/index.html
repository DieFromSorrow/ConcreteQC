<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>混凝土质量缺陷检测平台</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link rel="stylesheet" href="../static/style.css">
</head>
<body>
    <!-- 科技感装饰 -->
    <div class="tech-grid"></div>
    <div class="tech-pulse"></div>

    <div class="d-flex">
        <!-- 左侧项目列表 -->
        <div id="project-sidebar">
            <div class="sidebar-header">
                <h5 class="mb-0"><i class="fas fa-project-diagram"></i> <span>项目列表</span></h5>
                <button id="toggleSidebar" class="toggle-btn">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>
            <div id="project-list">
                <!-- 项目列表将通过JS动态生成 -->
            </div>
        </div>

        <!-- 主内容区域 -->
        <div id="main-content" class="flex-grow-1">
            <!-- 主标题 -->
            <div class="main-header">
                <h1><i class="fas fa-hard-hat"></i> 混凝土质量缺陷检测平台</h1>
            </div>

            <!-- 主体三列布局 -->
            <div class="dashboard-container">
                <!-- 左侧列 -->
                <div class="dashboard-column left-column">
                    <!-- 项目概况 -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-info-circle"></i> 项目概况
                        </div>
                        <div class="card-body">
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">项目名称</div>
                                    <div class="info-value" id="project-name">-</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">施工单位</div>
                                    <div class="info-value" id="construction-unit">-</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">建筑面积 (m²)</div>
                                    <div class="info-value" id="building-area">-</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">总工期 (天)</div>
                                    <div class="info-value" id="project-duration">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 巡检概况 -->
                    <div class="dashboard-card">
                        <div class="card-header">
                            <i class="fas fa-clipboard-check"></i> 巡检概况
                        </div>
                        <div class="card-body">
                            <div class="info-grid">
                                <div class="info-item">
                                    <div class="info-label">巡检面积 (m²)</div>
                                    <div class="info-value" id="inspection-area">-</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">巡检时间</div>
                                    <div class="info-value" id="inspection-time">-</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">巡检照片总数</div>
                                    <div class="info-value" id="total-photos">-</div>
                                </div>
                                <div class="info-item">
                                    <div class="info-label">病害照片总数</div>
                                    <div class="info-value" id="defect-photos">-</div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- 病害分布占比 -->
                    <div class="dashboard-card" style="flex: 1; display: flex; flex-direction: column;">
                        <div class="card-header">
                            <i class="fas fa-chart-pie"></i> 病害分布占比
                        </div>
                        <div class="card-body" style="flex: 1; display: flex; padding: 5px;">
                            <div class="distribution-container">
                                <div class="chart-container">
                                    <canvas id="defect-distribution-chart"></canvas>
                                </div>
                                <div class="distribution-list" id="defect-distribution-list">
                                    <!-- 病害分布列表将通过JS动态生成 -->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 中间列 -->
                <div class="dashboard-column middle-column">
                    <div class="dashboard-card" style="height: 100%;">
                        <div class="card-header">
                            <i class="fas fa-image"></i> 病害图像
                        </div>
                        <div class="defect-image-container">
                            <img id="defect-image" class="defect-image" src="https://images.unsplash.com/photo-1543857778-c4a1a569e7bd?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80" alt="病害图像">
                        </div>
                        <div class="defect-records">
                            <h6><i class="fas fa-list"></i> 发现记录</h6>
                            <div id="defect-records-list">
                                <!-- 病害记录将通过JS动态生成 -->
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 右侧列 -->
                <div class="dashboard-column right-column">
                    <!-- 病害概况 -->
                    <div class="dashboard-card" style="flex: 1.2;">
                        <div class="card-header">
                            <i class="fas fa-bug"></i> 病害概况
                        </div>
                        <div class="card-body">
                            <div id="defect-types-list">
                                <!-- 病害类型列表将通过JS动态生成 -->
                            </div>
                        </div>
                    </div>

                    <!-- 病害高发区域 -->
                    <div class="dashboard-card" style="flex: 0.8;">
                        <div class="card-header">
                            <i class="fas fa-map-marked-alt"></i> 病害高发区域
                        </div>
                        <div class="card-body" style="padding: 0;">
                            <div class="bar-chart-container">
                                <canvas id="high-frequency-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // 虚拟数据
        const projects = [
            {
                id: 1,
                name: "京沪高铁桥梁工程",
                constructionUnit: "中铁四局集团",
                buildingArea: "125,600",
                duration: "360",
                inspectionArea: "98,500",
                inspectionTime: "2023-06-15",
                totalPhotos: 2450,
                defectPhotos: 320,
                defectDistribution: [
                    { type: "露筋", percentage: 45, color: "#FF6384" },
                    { type: "缺棱掉角", percentage: 25, color: "#36A2EB" },
                    { type: "夹渣", percentage: 15, color: "#FFA2AB" },
                    { type: "裂渗", percentage: 8, color: "#4BC0C0" },
                    { type: "连接缺陷", percentage: 7, color: "#9966FF" },
                    { type: "孔洞类缺陷", percentage: 13, color: "#8296A8"}
                ],
                defects: [
                    {
                        id: 101,
                        type: "裂缝",
                        count: 142,
                        image: "https://images.unsplash.com/photo-1581091226033-d5c48150dbaa?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                        records: [
                            { id: 1001, location: "3#桥墩", date: "2023-05-12", severity: "中度", inspector: "张工" },
                            { id: 1002, location: "5#梁板", date: "2023-05-18", severity: "轻度", inspector: "李工" },
                            { id: 1003, location: "2#桥墩", date: "2023-06-02", severity: "重度", inspector: "王工" },
                            { id: 1004, location: "7#梁板", date: "2023-06-10", severity: "中度", inspector: "赵工" }
                        ]
                    },
                    {
                        id: 102,
                        type: "蜂窝麻面",
                        count: 78,
                        image: "https://images.unsplash.com/photo-1581091226033-d5c48150dbaa?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                        records: [
                            { id: 2001, location: "4#桥墩", date: "2023-05-20", severity: "轻度", inspector: "张工" },
                            { id: 2002, location: "1#梁板", date: "2023-05-25", severity: "中度", inspector: "李工" }
                        ]
                    },
                    {
                        id: 103,
                        type: "露筋",
                        count: 48,
                        image: "https://images.unsplash.com/photo-1560518883-ce09059eeffa?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                        records: [
                            { id: 3001, location: "6#桥墩", date: "2023-06-05", severity: "中度", inspector: "王工" },
                            { id: 3002, location: "3#梁板", date: "2023-06-08", severity: "重度", inspector: "赵工" }
                        ]
                    },
                    {
                        id: 104,
                        type: "孔洞",
                        count: 25,
                        image: "https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                        records: [
                            { id: 4001, location: "2#桥墩", date: "2023-05-30", severity: "重度", inspector: "张工" }
                        ]
                    },
                    {
                        id: 105,
                        type: "其他",
                        count: 27,
                        image: "https://images.unsplash.com/photo-1581092580497-e0d23cbdf1dc?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                        records: [
                            { id: 5001, location: "5#桥墩", date: "2023-06-12", severity: "轻度", inspector: "李工" }
                        ]
                    }
                ],
                highFrequencyAreas: [
                    { area: "", count: 48 },
                    { area: "5#梁板", count: 42 },
                    { area: "2#桥墩", count: 38 },
                    { area: "7#梁板", count: 35 },
                    { area: "4#桥墩", count: 30 },
                    { area: "1#梁板", count: 28 },
                    { area: "6#桥墩", count: 25 }
                ]
            },
            {
                id: 2,
                name: "深圳湾跨海大桥",
                constructionUnit: "中交第二航务工程局",
                buildingArea: "98,300",
                duration: "420",
                inspectionArea: "85,200",
                inspectionTime: "2023-07-10",
                totalPhotos: 3120,
                defectPhotos: 280,
                defectDistribution: [
                    { type: "露筋", percentage: 11, color: "#FF6384" },
                    { type: "缺棱掉角", percentage: 11, color: "#36A2EB" },
                    { type: "夹渣", percentage: 22, color: "#FFA2AB" },
                    { type: "裂渗", percentage: 33, color: "#4BC0C0" },
                    { type: "连接缺陷", percentage: 8, color: "#9966FF" },
                    { type: "孔洞类缺陷", percentage: 13, color: "#8296A8"}
                ],
                defects: [
                    {
                        id: 201,
                        type: "裂缝",
                        count: 106,
                        image: "https://images.unsplash.com/photo-1543857778-c4a1a569e7bd?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                        records: [
                            { id: 6001, location: "主桥墩", date: "2023-06-20", severity: "中度", inspector: "陈工" }
                        ]
                    },
                    {
                        id: 202,
                        type: "蜂窝麻面",
                        count: 89,
                        image: "https://images.unsplash.com/photo-1581091226033-d5c48150dbaa?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                        records: [
                            { id: 7001, location: "引桥", date: "2023-06-25", severity: "轻度", inspector: "刘工" }
                        ]
                    }
                ],
                highFrequencyAreas: [
                    { area: "主桥墩", count: 65 },
                    { area: "引桥", count: 52 },
                    { area: "西侧桥面", count: 48 },
                    { area: "东侧桥面", count: 42 },
                    { area: "南桥塔", count: 35 },
                    { area: "北桥塔", count: 28 },
                    { area: "锚碇区", count: 10 }
                ]
            },
            {
                id: 3,
                name: "上海中心大厦",
                constructionUnit: "上海建工集团",
                buildingArea: "432,000",
                duration: "980",
                inspectionArea: "385,000",
                inspectionTime: "2023-08-05",
                totalPhotos: 5680,
                defectPhotos: 420,
                defectDistribution: [
                    { type: "露筋", percentage: 22, color: "#FF6384" },
                    { type: "缺棱掉角", percentage: 65, color: "#36A2EB" },
                    { type: "夹渣", percentage: 15, color: "#FFA2AB" },
                    { type: "裂渗", percentage: 8, color: "#4BC0C0" },
                    { type: "连接缺陷", percentage: 17, color: "#9966FF" },
                    { type: "孔洞类缺陷", percentage: 2, color: "#8296A8"}
                ],
                defects: [
                    {
                        id: 301,
                        type: "裂缝",
                        count: 168,
                        image: "https://images.unsplash.com/photo-1543857778-c4a1a569e7bd?ixlib=rb-4.0.3&auto=format&fit=crop&w=800&q=80",
                        records: [
                            { id: 8001, location: "核心筒", date: "2023-07-22", severity: "中度", inspector: "孙工" }
                        ]
                    }
                ],
                highFrequencyAreas: [
                    { area: "核心筒", count: 85 },
                    { area: "58层梁板", count: 72 },
                    { area: "32层柱", count: 68 },
                    { area: "102层", count: 58 },
                    { area: "地下三层", count: 45 },
                    { area: "设备层", count: 42 },
                    { area: "顶层结构", count: 35 }
                ]
            }
        ];

        // 当前选中的项目和病害
        let currentProjectId = 1;
        let currentDefectId = 101;

        // 初始化页面
        $(document).ready(function() {
            // 初始化项目列表
            initProjectList();

            // 默认加载第一个项目
            if (projects.length > 0) {
                loadProjectData(currentProjectId);
            }

            // 侧边栏折叠/展开功能
            // 侧边栏折叠/展开功能
            $('#toggleSidebar').click(function() {
                $('#project-sidebar').toggleClass('collapsed');
                $('#main-content').toggleClass('expanded');

                const icon = $(this).find('i');
                if ($('#project-sidebar').hasClass('collapsed')) {
                    icon.removeClass('fa-chevron-left').addClass('fa-chevron-right');
                } else {
                    icon.removeClass('fa-chevron-right').addClass('fa-chevron-left');
                }

                // 重新调整图表大小
                setTimeout(function() {
                    if (window.defectDistributionChart) {
                        window.defectDistributionChart.resize();
                    }
                    if (window.highFrequencyChart) {
                        window.highFrequencyChart.resize();
                    }
                }, 300);
            });
        });

        // 初始化项目列表
        function initProjectList() {
            const projectList = $('#project-list');
            projectList.empty();

            projects.forEach(project => {
                const projectItem = $('<div>')
                    .addClass('project-item')
                    .attr('data-id', project.id)
                    .html(`<i class="fas fa-building"></i> <span>${project.name}</span>`)
                    .click(function() {
                        $('.project-item').removeClass('active');
                        $(this).addClass('active');
                        currentProjectId = project.id;
                        loadProjectData(project.id);
                    });

                if (project.id === currentProjectId) {
                    projectItem.addClass('active');
                }

                projectList.append(projectItem);
            });
        }

        // 加载项目数据
        function loadProjectData(projectId) {
            const project = projects.find(p => p.id === projectId);
            if (!project) return;

            // 更新项目概况
            $('#project-name').text(project.name);
            $('#construction-unit').text(project.constructionUnit);
            $('#building-area').text(project.buildingArea);
            $('#project-duration').text(project.duration);

            // 更新巡检概况
            $('#inspection-area').text(project.inspectionArea);
            $('#inspection-time').text(project.inspectionTime);
            $('#total-photos').text(project.totalPhotos);
            $('#defect-photos').text(project.defectPhotos);

            // 更新病害分布图
            updateDefectDistributionChart(project.defectDistribution);

            // 更新病害分布列表
            updateDefectDistributionList(project.defectDistribution);

            // 更新病害类型列表
            updateDefectTypesList(project.defects);

            // 更新病害高发区域图表
            updateHighFrequencyChart(project.highFrequencyAreas);

            // 默认加载第一个病害
            if (project.defects.length > 0) {
                loadDefectData(project.defects[0].id);
            }
        }

        // 更新病害分布图表
        function updateDefectDistributionChart(distribution) {
            const ctx = $('#defect-distribution-chart');
            const labels = distribution.map(item => item.type);
            const data = distribution.map(item => item.percentage);
            const colors = distribution.map(item => item.color);

            if (window.defectDistributionChart) {
                window.defectDistributionChart.destroy();
            }

            window.defectDistributionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: data,
                        backgroundColor: colors,
                        borderColor: 'rgba(15, 23, 42, 0.8)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            callbacks: {
                                label: function(context) {
                                    return `${context.label}: ${context.parsed}%`;
                                }
                            }
                        }
                    }
                }
            });
        }

        // 更新病害分布列表
        function updateDefectDistributionList(distribution) {
            const list = $('#defect-distribution-list');
            list.empty();

            distribution.forEach(item => {
                const itemElement = $('<div>').addClass('distribution-item');
                const colorBox = $('<span>').css({
                    'display': 'inline-block',
                    'width': '10px',
                    'height': '10px',
                    'background': item.color,
                    'margin-right': '6px',
                    'border-radius': '2px'
                });

                itemElement.append(
                    $('<div>').append(
                        colorBox,
                        $('<span>').text(item.type)
                    ),
                    $('<span>').text(`${item.percentage}%`)
                );

                list.append(itemElement);
            });
        }

        // 更新病害类型列表
        function updateDefectTypesList(defects) {
            const list = $('#defect-types-list');
            list.empty();

            defects.forEach(defect => {
                const item = $('<div>')
                    .addClass('defect-type-item')
                    .attr('data-id', defect.id)
                    .html(`
                        <div>
                            <i class="fas fa-circle-notch"></i> ${defect.type}
                        </div>
                        <div class="defect-count">${defect.count}</div>
                    `)
                    .click(function() {
                        $('.defect-type-item').removeClass('active');
                        $(this).addClass('active');
                        loadDefectData(defect.id);
                    });

                if (defect.id === currentDefectId) {
                    item.addClass('active');
                }

                list.append(item);
            });
        }

        // 加载病害数据
        function loadDefectData(defectId) {
            currentDefectId = defectId;

            // 查找当前项目的当前病害
            const project = projects.find(p => p.id === currentProjectId);
            if (!project) return;

            const defect = project.defects.find(d => d.id === defectId);
            if (!defect) return;

            // 更新病害图像
            $('#defect-image').attr('src', defect.image);

            // 更新病害记录
            updateDefectRecords(defect.records);
        }

        // 更新病害记录
        function updateDefectRecords(records) {
            const list = $('#defect-records-list');
            list.empty();

            records.forEach(record => {
                const severityClass = record.severity === '轻度' ? 'text-info' :
                                    record.severity === '中度' ? 'text-warning' : 'text-danger';

                const recordElement = $('<div>').addClass('record-item').html(`
                    <div><i class="fas fa-hashtag"></i> ID: ${record.id}</div>
                    <div><i class="fas fa-map-marker-alt"></i> ${record.location}</div>
                    <div><i class="fas fa-calendar-alt"></i> ${record.date}</div>
                    <div><i class="fas fa-user-hard-hat"></i> ${record.inspector}</div>
                    <div><i class="fas fa-exclamation-triangle"></i> <span class="${severityClass}">${record.severity}</span></div>
                `);

                list.append(recordElement);
            });
        }

        // 更新病害高发区域图表
        function updateHighFrequencyChart(areas) {
            const ctx = $('#high-frequency-chart');
            const labels = areas.map(item => item.area);
            const data = areas.map(item => item.count);

            if (window.highFrequencyChart) {
                window.highFrequencyChart.destroy();
            }

            window.highFrequencyChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: '病害数量',
                        data: data,
                        backgroundColor: 'rgba(54, 162, 235, 0.7)',
                        borderColor: 'rgba(54, 162, 235, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            grid: {
                                color: 'rgba(64, 158, 255, 0.1)'
                            },
                            ticks: {
                                color: '#94a3b8'
                            }
                        },
                        y: {
                            grid: {
                                color: 'rgba(64, 158, 255, 0.1)'
                            },
                            ticks: {
                                color: '#94a3b8',
                                font: {
                                    size: 10
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
        }
    </script>
</body>
</html>
